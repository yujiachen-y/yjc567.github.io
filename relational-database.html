<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>关系型数据库&nbsp;|&nbsp;Jiachen’s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="关系型数据库">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG"></span>&nbsp;
      
      <span>主页</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E6%9D%82%E6%96%87.html">
    <div class="Navbar__Btn">
      <span>杂文</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E6%8A%80%E6%9C%AF.html">
    <div class="Navbar__Btn">
      <span>技术</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E9%98%85%E8%AF%BB.html">
    <div class="Navbar__Btn">
      <span>阅读</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="other.html">
        <div class="Navbar__Btn">
          
          <span>其他</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
          <span>关于</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">关系型数据库</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on 2023年11月16日周四</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/技术.html">技术</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/90e60188cf2d4c1ab1c81368b4f7ee29" class="PageRoot"><ul id="https://www.notion.so/5e15f7ede1d747169a0c4dd7c55eabb1" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/5160f2e8f0cd4108ada11620163a9af6"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">存储结构</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/87bb492156d64d85afaff51b1c259614"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Hash 索引</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b714625e60084424947ec7fd13ed5fd0"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">SSTable</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/69f70918f08540edb02f2978da2f96da"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">B-tree</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f3f46047fae0424f92bfec768cfbf1bf"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">跳表</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0055953441934350a4633d5ab5cb51c3"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">InnoDB</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1dc8258034ac4c6f9b107280512b3926"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">锁</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f15da282eec1462797667eaf5e5c19f0"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">索引</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b66b4b10478642668aa59304ab82f3fe"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">MVCC</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/6f0927715d4c482fb3ff11af50fa7a78"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Index Merge</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2b7565c7bf1341baaea06dc590462404"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">binlog</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3570366ae5c6453fb9e2bc7b1be48400"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">redo log</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2e933ff363c045379fb63e0c2a2485ff"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">undo log</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/1c2566674d794d2996e19fb96c0076a4"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">事务的级别</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7c990e6c27524881abeef78131da2739"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">MySQL</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/99738ce571d04aeba4d4da21122306a8"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">基础规范</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/45559a09af784817b7697ced62a4c327"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">使用规范</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2c03e24984734fdb871472240b1a4dc8"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">优化思路</span></span></div></a></li></ul><h1 id="https://www.notion.so/5160f2e8f0cd4108ada11620163a9af6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5160f2e8f0cd4108ada11620163a9af6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">存储结构</span></span></h1><h2 id="https://www.notion.so/87bb492156d64d85afaff51b1c259614" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/87bb492156d64d85afaff51b1c259614"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Hash 索引</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/37355260105e4be3a2710a13b6b13baf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">维护一个kv map，v可以是数据，也可以是数据在磁盘上的位置。</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/b26c8c9f564c4ea8a02c79b7b780a2bb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一般使用日志文件的偏移量，这样文件的写入就只需要append操作，文件变大后合并。</span></span></li></ul></li><li id="https://www.notion.so/83ed648c425d40c893932464f965cdf9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">实现简单。</span></span></li><li id="https://www.notion.so/b275d8fdc03e4dda901b90329c3fe4d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">必须全部放入内存，在磁盘上维护速度会很慢；区间查询效率不高。</span></span></li></ul><h2 id="https://www.notion.so/b714625e60084424947ec7fd13ed5fd0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b714625e60084424947ec7fd13ed5fd0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">SSTable</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/e567186d0c2a45c387809bed0d63aa59" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对哈希日志文件的改进，要求每个文件中的key是有序的。</span></span></li><li id="https://www.notion.so/6e48565b7fdc4d67a1011366bba7c885" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">优点：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/1a4f4a036d5241fd88646eeb861a6a2c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">合并更加高效，桶排序可以在文件大于内存的时候正常工作；</span></span></li><li id="https://www.notion.so/bd70c42f54274d10aaba3d2cf1e74b2e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">不需要内存中保存所有key的值，保存部分区间就可以了；</span></span></li><li id="https://www.notion.so/469e38eee20949a697b974a5908819f8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">可以根据key的前缀对一批key做压缩，节省磁盘空间，I/O带宽变小。</span></span></li></ul></li><li id="https://www.notion.so/bedd48f159f84c37814268d74d97112d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">相关实现：Cassandra、HBase、Lucene。</span></span></li></ul><div id="https://www.notion.so/aaf29f3ed2f14fca8b6fa4f7216915bc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/ae78ae99cf0d46c9ae402cf4cfc0dab8" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">当写入时，将其添加到内存中的平衡数据结构中（例如红黑树）。</span></span></li><li id="https://www.notion.so/77c2a810259b4c90aaedc9e000cfcc53" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">当内存大于某个阈值（通常为几兆字节）时，将其作为SSTable文件写入磁盘。</span></span></li><li id="https://www.notion.so/ff71374877d04ceaaca1f860525d4185" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">为了处理读请求，首先尝试在内存表中查找键，然后是最新的磁盘段文件，接下来是次新的磁盘段文件，以此类推，直到找到目标（或为空）。</span></span></li><li id="https://www.notion.so/2fbc807b3c9a4c96a8eec779fba6a10f" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">后台进程周期性地执行段合并与压缩过程，以合并多个段文件，并丢弃那些已被覆盖或删除的值。</span></span></li></ol><h2 id="https://www.notion.so/69f70918f08540edb02f2978da2f96da" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/69f70918f08540edb02f2978da2f96da"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">B-tree</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/bf47ccf638f543a48986be51fc82c2ab" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">B-tree保留按键排序的key-value对，将数据库分解成固定大小的页面，不同页面之间可以互相引用，每个页面对应一个连续的范围，包含若干键和对子页的引用。</span></span></li><li id="https://www.notion.so/2caacba73f7944dda7839f79859eb95a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">优点：</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/d4d827c8910a413ab17ea2bf180f4f6c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">稳定的性能表现；</span></span></li><li id="https://www.notion.so/65dc38cde0bf45f2bafb66c58f4f58d2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">日志系统的一个key可能在多处出现，而B-tree可以更好地支持事务。</span></span></li></ul></li><li id="https://www.notion.so/c41c196cad4346348c1e852fd14b7699" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">几乎所有关系数据库中的标准索引实现，许多非关系型数据库也经常使用。</span></span></li></ul><div id="https://www.notion.so/29f0977e00de43dfab397971aa1a43d0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/798d1e26d5f34cff9bbd4754dfd5a212" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">B+ 树和 B 树的区别：B+ 树把所有数据都存储在叶节点中，而 B 树在非叶子结点也会存储数据。</span></span></p></div><div id="https://www.notion.so/66df1314bfeb44369f437c7ed2c05599" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">InnoDB 使用的是 B+ 树，因为 B+ 树对范围查询更高效。</span></span></p></div><div id="https://www.notion.so/9eed898aeaf64c289ef43240ff5f324c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">InnoDB 使用 B+ 树：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/351bc4f490884677b231c1a4844bce51" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">范围查询、顺序读取支持更好，锁的范围更可控。</span></span></li><li id="https://www.notion.so/84fbe28e31494e6e96c1a67435907bb3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">相同数据 B+ 树更矮，IO 更少。</span></span></li><li id="https://www.notion.so/e2a5a1a47870447b9a7d63268a7a76bd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">方便缓存。</span></span></li></ul><h2 id="https://www.notion.so/f3f46047fae0424f92bfec768cfbf1bf" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f3f46047fae0424f92bfec768cfbf1bf"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">跳表</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/8d6fc9583f6f400487be3467adc7693c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">稳定性</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/b1e9c288ca704819a463b0f9a4143f74" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">B+ tree的结构、查询和插入过程是稳定的</span></span></li><li id="https://www.notion.so/cdbc2806f45d4cb78cfd3c630334de2e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">跳表插入时是否要把数放在上一层由随机函数出现</span></span></li></ul></li><li id="https://www.notion.so/47fbb7242f9945659bfd247b5c2c52a2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">IO读写</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/748ef5dd72b64610b4c69002c3e6dfd0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">B+ tree通常用在数据库，B+ tree的树高很低，所以磁盘IO次数会很小</span></span></li><li id="https://www.notion.so/8cd5b30e9f704cad83ddeac7f05b41a7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">跳表用在内存里，没有IO的问题，当然跳表的高度较高，如果放在磁盘中，IO次数会增加。</span></span></li></ul></li><li id="https://www.notion.so/df05c5058f304b169933b1e9ce778a0c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">读写操作</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/518af38100ae442e9ec3ca070e95a0f8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">B+ tree适合读多的场景，插入过程较麻烦，但是查找很快。</span></span></li><li id="https://www.notion.so/40609860545c4b119b5aabd50147f71a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">跳表查询时走的层次多，但是插入更快，不需要去平衡数据结构。</span></span></li></ul></li><li id="https://www.notion.so/c63f7de844b24477bbdb7592b3ff8293" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">代码实现</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/33301106a4aa4c62939b957954e3bf20" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">B+ tree需要考虑很多操作、节点的拆分，合并</span></span></li><li id="https://www.notion.so/8bc3832ceee14ad18ee65104756fd7ad" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">跳表纯随机，靠概率保证性能，实现起来就不需要考虑很多因素。</span></span></li></ul></li></ul><h1 id="https://www.notion.so/0055953441934350a4633d5ab5cb51c3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/0055953441934350a4633d5ab5cb51c3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">InnoDB</span></span></h1><div id="https://www.notion.so/3e637bcb95684809ab6e4bf905d4e415" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">MySQL一个table中数据在磁盘上的排列是以clustered index为序的，在没有特殊设置的情况下，clustered index为primary key，如果没有primary key，就会找第一个不允许空值的unique key作为clustered index，还没有的话，db会自己生成一个index。</span></span></p></div><h2 id="https://www.notion.so/1dc8258034ac4c6f9b107280512b3926" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1dc8258034ac4c6f9b107280512b3926"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">锁</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/a2c15a04a6f54fb2a32ded73e11aa973" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Shared and exclusive locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/c5d88b9b289245529d6042ba538db30c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">只是锁的类别，没有具体语句。</span></span></li></ul></li><li id="https://www.notion.so/d0434c8ab34f4596870ccc782ab20704" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Intention locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/d0dafc21945843a998eef58b4e59f7d1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">表级别锁，用来表示一个事务之后会对某些行上什么类别的锁。</span></span></li><li id="https://www.notion.so/966d47c6d10a482b83dc62635788606d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一个事务获得行锁的必要条件是先获得对应表的，相同或更高等级的意向锁。</span></span></li><li id="https://www.notion.so/22499f7237924c49ba3e6fb366fe6d6c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SELECT ... FOR SHARE</span></span></li><li id="https://www.notion.so/a784c0c660a049eca586a7441acbd5a3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SELECT ... FOR UPDATE</span></span></li></ul></li><li id="https://www.notion.so/475fbcb2000a4cc684f3c2458b428528" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Record locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/110548f3b23241af9786bc1d99aa77c6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE</span></span></li></ul></li><li id="https://www.notion.so/93f62ceb70194f9c93c7224d654628b5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Gap locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/e203c4fdec6c44c19b862110550f517f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">在index records之间的gap，或第一个index records之前，第二个index records之后的锁。</span></span></li><li id="https://www.notion.so/be73a0c27d834af8ac45a663d11211b7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当搜索条件不是unique index的时候就会用到gap lock。</span></span></li><li id="https://www.notion.so/a4d59bf044d44851a4478e23d82afcff" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</span></span></li></ul></li><li id="https://www.notion.so/10cc2d0996c344a4b2b220520c5d7613" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Next-key locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/de914401525f489a86158b3e1362dc0c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">index-record lock + gap lock preceding the index record.</span></span></li></ul></li><li id="https://www.notion.so/6e64dbc994554ce995d2248b6ff1897d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Insert intention locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/5a57b6dc5ffd47f7a5e137b684ed9050" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">insert时施加的gap锁，只要最终操作的index不同就不会互相block。</span></span></li></ul></li><li id="https://www.notion.so/32c4b93aa86244a6a3c869c9e0c48a07" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">AUTO-INC locks</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/478f83910d3b4982a197213c8a78c275" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">特殊的table lock。</span></span></li></ul></li><li id="https://www.notion.so/b461121a3bd2461f92cfaa7730ad6674" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Predicate locks for spatial indexes</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/bc919a35646a4d54b5c917b0426c6194" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">用在spatial data上，锁的是minimum bounding rectangle values。</span></span></li></ul></li></ul><h2 id="https://www.notion.so/f15da282eec1462797667eaf5e5c19f0" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f15da282eec1462797667eaf5e5c19f0"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">索引</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/7e01892009a8411db4a343edaeaebf9c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">主键</span></span></li><li id="https://www.notion.so/20bd6196175d4cadab387a002f1b43a4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">唯一索引，在关系型数据库中给数据施加更多的约束。</span></span></li><li id="https://www.notion.so/1e1bc017a61a4188aceeda353652dea3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">二级索引，和前两者也类似，但不需要每条记录都有唯一的键。</span></span></li><li id="https://www.notion.so/ade4de54372b4e79a6b26743052a7665" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">聚集索引，存储数据的具体位置，方便其他索引引用，InnoDB把主键作为聚集索引。</span></span></li></ul><div id="https://www.notion.so/6a8c7ef4d5c8417eb59e98d0752a69dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一些逻辑上的索引</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/70dcc1b938e14f6596fe8de4676f89c9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">覆盖索引，索引包含了查询需要的所有字段，这样查到相关数据后，索引值就是结果，不需要回表去查找更多的数据。</span></span></li></ul><h2 id="https://www.notion.so/b66b4b10478642668aa59304ab82f3fe" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b66b4b10478642668aa59304ab82f3fe"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">MVCC</span></span></h2><div id="https://www.notion.so/5a964253aa24494db32afcc9960a2c93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">每行记录包含了两个隐藏字段，事务id trx_id 和回滚指针 roll_pointer。</span></span></p></div><div id="https://www.notion.so/9b1355bff7614b4b89decd82af0cb7f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其中回滚指针指向对应undo log的地址，undo log在每次变动前被创建，相关的记录连在一起就变成了一个版本链。</span></span></p></div><div id="https://www.notion.so/5d5e34a772fd4b5bb4e1985915826a9e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果一个事务不应该读取当前的版本，那么这个事务就会通过roll_pointer找到之前的版本。</span></span></p></div><h2 id="https://www.notion.so/6f0927715d4c482fb3ff11af50fa7a78" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6f0927715d4c482fb3ff11af50fa7a78"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Index Merge</span></span></h2><div id="https://www.notion.so/78746e8ebdb0431e93c51229974e40e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当一个查询涉及多个索引的时候，优化器会在这两种策略中选择一种去执行</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/417e746c6ca24d87ba70963ab7f0194a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">根据索引的顺序，先查到第一个索引对应的记录，然后用剩下的索引条件做filter。</span></span></li><li id="https://www.notion.so/afe45e2b0cbe48c8bd67cc5d6d4006c5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">对多个索引并行对应的主键，merge结果，找到符合要求的记录。</span></span></li></ul><div id="https://www.notion.so/b135118cb69048fe8f991de0acf26982" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时多个索引都会加入到锁机制中，很有可能不同类型的索引对应的区间有交叉，这就会带来死锁。</span></span></p></div><h2 id="https://www.notion.so/2b7565c7bf1341baaea06dc590462404" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2b7565c7bf1341baaea06dc590462404"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">binlog</span></span></h2><div id="https://www.notion.so/b44fc4650e174dc49cf4d88221ff43f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">https://dev.mysql.com/doc/internals/en/binary-log-overview.html</span></span></p></div><div id="https://www.notion.so/110daab334934fefa5353f964fa409da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有关数据修改的操作记录，记录了有可能导致数据更新的操作，以及一些相关的metadata。</span></span></p></div><div id="https://www.notion.so/03e1c68271594af9b69b416801936dbd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">两种实现方式：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/53fbd76e126344e8bf01be584064c79a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">statement-based</span></span></li><li id="https://www.notion.so/b3beb0c07f8a4511af3db216faebd423" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">row-based</span></span></li></ul><div id="https://www.notion.so/91e12ea9ed334df58baca3344fedbb43" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">用于：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/63752078e82244f5ae17bfb78f522650" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">主从复制</span></span></li><li id="https://www.notion.so/ab19c3f507b1451a9b386ea2702137be" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">数据恢复</span></span></li></ul><h2 id="https://www.notion.so/3570366ae5c6453fb9e2bc7b1be48400" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/3570366ae5c6453fb9e2bc7b1be48400"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">redo log</span></span></h2><div id="https://www.notion.so/3fbeae3a99a5451484bd43b875aad998" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果每次事务结束的时候都要去把数据写入磁盘，会非常耗时，而且InnoDB修改的是页，等于是把页块随机IO进磁盘。因此引入了redo log，修改数据前先把修改的具体数据信息追加到log尾部，以减少数据页写入磁盘的频次。</span></span></p></div><div id="https://www.notion.so/af135380097a4c0ba43d308b4c6aacde" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">redo log是环形的，一旦写满就要求数据页写入磁盘，然后释放相应的log空间。</span></span></p></div><div id="https://www.notion.so/d21e7404f3be409887a272fd97678a88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果发生了故障，redo log可以用来追加未写入磁盘的改动。</span></span></p></div><h2 id="https://www.notion.so/2e933ff363c045379fb63e0c2a2485ff" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2e933ff363c045379fb63e0c2a2485ff"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">undo log</span></span></h2><div id="https://www.notion.so/35917d93a43b4eef80c0d7415c736d3f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html">https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html</a></span></span></p></div><div id="https://www.notion.so/33411366e04541b0bee47f5274a5a1a9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">记录用来回滚事务需要的信息，MVCC的版本信息也依赖此实现。</span></span></p></div><h2 id="https://www.notion.so/1c2566674d794d2996e19fb96c0076a4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1c2566674d794d2996e19fb96c0076a4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">事务的级别</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/f1c3006ece394d06978f51e31e9b82f8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">READ UNCOMMITTED，没有事务，或者说事务的中间状态会被其他事务看见。 更新丢失 -&gt; 上锁，CAS 版本号，冲突检测</span></span></li><li id="https://www.notion.so/0c7e01c93d3d40169476b6189544fd17" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">READ COMMITTED，事务的中间状态不会被其他事务看见，但是已执行事务的结果会被其他事务看见。 脏读 + 脏写 -&gt; 读提交 -&gt; 读锁 / 直接MMVC。</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">数据的读取在这个隔离级别下是不加锁的。</strong></span></span></li><li id="https://www.notion.so/e3668446c5194027afd9280c1b4e45b0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">REPEATABLE READ，一个事务只会看到结束时间在其开始时间之前的事务操作结果。 不可重复读 / 读倾斜 -&gt; 可重复读 -&gt; MMVC</span></span></li><li id="https://www.notion.so/93ce895dd9ab4750a95d68a40c1d353f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SERIALIZABLE 幻读 / 写倾斜 -&gt; 可重复读 or 线性化 -&gt; MMVC &amp; next-key lock + 2PC(开始前拿锁，结束后释放锁) or 线性化</span></span></li></ul><h1 id="https://www.notion.so/7c990e6c27524881abeef78131da2739" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/7c990e6c27524881abeef78131da2739"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">MySQL</span></span></h1><div id="https://www.notion.so/e4d147c44dd6424e82793f1ee836b7be" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为什么选择 MySQL？因为这是个万金油数据库，方便系统迁移，方便私有化部署等。</span></span></p></div><h2 id="https://www.notion.so/99738ce571d04aeba4d4da21122306a8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/99738ce571d04aeba4d4da21122306a8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">基础规范</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/7e2ea24653a8419d9af5c9ec8be29c7a" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">一般场景下尽量使用InnoDB存储引擎。</span></span></li><li id="https://www.notion.so/045c676f859c476abf7321ac4683b194" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">新库字符集选择上使用utf8mb4字符集。</span></span></li><li id="https://www.notion.so/1408ae6f644545b7b28628e12bd9a145" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">线上数据库禁止使用存储过程、视图、触发器、Event，在高并发的场景下我们需要去解放DB的CPU，把一些可以上移的计算上移。</span></span></li></ol><h2 id="https://www.notion.so/45559a09af784817b7697ced62a4c327" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/45559a09af784817b7697ced62a4c327"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">使用规范</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/6a260c704e17443ab44eaf664ad71484" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">不要使用负向查询（不等于、not in、not like等）以及%开头的模糊查询；这些都会导致索引失效。</span></span></li><li id="https://www.notion.so/e3a883a0fbdb4d978c7f5280020d7633" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">不要在WHERE条件的字段上直接使用函数或者表达式；比如 from_unixtime(start_day) &gt; &#x27;...&#x27; 这样也会导致索引失效。</span></span></li><li id="https://www.notion.so/70f73c8730e74dd4bd56a2eedd267143" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">不要在WHERE条件的字段使用隐式转换；比如用int value去查询varchar的属性，这也会导致全表扫描。</span></span></li><li id="https://www.notion.so/2b68d93625554e9983c5fb2e1710c9a5" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">最好不要SELETE *，只获取必要的字段，显示说明列属性。</span></span><ol class="NumberedListWrapper"><li id="https://www.notion.so/d562d5278f1c4b1fa473185134391978" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">这会增加CPU、IO、net消耗。</span></span></li><li id="https://www.notion.so/8b8c8cc8ec574fdb8753f77363afeb3e" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">如果有覆盖索引的情况下，会导致无法有效利用覆盖索引。</span></span></li><li id="https://www.notion.so/89d6071aced641258698ac10e93c7199" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">可能会让字段的改变引发bug。</span></span></li></ol></li><li id="https://www.notion.so/e53ad72f126c4240bb45c07f3cbdf378" class="NumberedList" value="5"><span class="SemanticStringArray"><span class="SemanticString">分片库使用场景下，要求在线查询必须带分片键。</span></span></li></ol><h2 id="https://www.notion.so/2c03e24984734fdb871472240b1a4dc8" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2c03e24984734fdb871472240b1a4dc8"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">优化思路</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/8de33c3d52604d79b179eda24418cb89" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">减少数据访问</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/0f7703150b714df2892f144053880315" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Design：减少数据的访问，要从设计阶段就开始思考如何设计紧凑而高效的数据模型，表结构、字段类型、一机构字符编码等细节。</span></span></li><li id="https://www.notion.so/5522a90b0a9549c7b7013f490d2dd00d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Index：包含如何建立合理索引和高效地使用索引，理解清楚表的结构以及不同存储引擎的特性。</span></span></li><li id="https://www.notion.so/baffcf592a1e4aefac66fe1ddeaec731" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">SQL Plan：主要是如何写出高效的 SQL 语句，尤其是涉及到复杂的 join 和 sorting。通常可以通过 explain 来查看 SQL 的执行计划和反馈的数据指标，找到优化的切入点。</span></span></li><li id="https://www.notion.so/9a1c19a725904e82a6a8fdde606e901a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Compression：压缩也是用于减少数据访问的常见手段，但通常压缩会引入 CPU 的消耗，具体要看业务场景来取舍。</span></span></li></ul></li><li id="https://www.notion.so/4b7e1299ad894e4794a975fd8e09dbc8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">减少数据访问 / 数据传输</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/252bb78e77214053a87ce87cbcd94bef" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Pagination：绝大多数 OLTP 场景，查询大量数据的时候都可以采用 pagination 手段， MySQL 中常见的就是 Limit + Offset。Pagination 之后，网络传输和 MySQL Server 上从磁盘读数据的多个环节，就可以形成一个 pipeline，有利于更合理地利用磁盘 IOPS 和网络带宽。同时又避免了 MySQL Server 端和应用程序端的大量内存被占用。当然，有时 where 条件就可以很好地进行 pagination，这种情况优先采用 where 条件进行 pagination。</span></span></li><li id="https://www.notion.so/a40d61eb6ff34d709ef7b01ad00408ba" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Result Size：不要查询和传输不必要的数据，比如只查询需要的字段。</span></span></li></ul></li><li id="https://www.notion.so/648f38a42f3b4a53827315838cd5ab54" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">减少网络传输</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/14cad8657b3847cd969392cf2886d0c3" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Batch：发送到数据库的每个数据块中的最大值数。建议对访问延迟较大（client 和 MySQL 之间网络 RTT 大）的数据库使用较高的值，当用户数量较多时使用较低的值。</span></span></li><li id="https://www.notion.so/c8ad276765d7495b8c046ac4b42ee346" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">FetchSize：从数据库中检索的每个数据块中的最大值数。优化建议同上。</span></span></li></ul></li><li id="https://www.notion.so/3c3b1bc4738941668ca7dd115dd7179a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">减少 CPU 运算和内存占用（感觉这个也是可以前期考虑的</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/7fda65a30cb24ea0a8e2767c04891202" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Sort：SQL 中排序是一个耗 CPU 的操作，一方面尽量避免 sort，比如利用索引就是一种避免 sort 的方法。如果索引不奏效，就需要依赖 filesort，二 filesort 的性能又和 sort_buffer_size 参数有关，内存中无法完成 filesort 时还会借助临时文件来完成 sort，临时文件的读写性能又和 tmpdir 参数设置有关。其次要尽量让参与 sort 的数据量比较小。</span></span></li><li id="https://www.notion.so/b98e7ad7ac09425cbbab32578d6d6b01" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Bind Var：不要在 where 里面执行计算，提前把 where 的参数计算好。</span></span></li></ul></li><li id="https://www.notion.so/1dab17257a01451e9692f9507338c5b6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">增加资源</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/6ac7dcfe36c34c6ea1385d53501ec56e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Parallel：通过增加资源提升并行度，比如向集群中加入更多的服务器，然后迁移部分数据分片到新服务器；如果计算能力足够但 IOPS 不够的情况，给服务器多家一个磁盘控制器，多挂一块磁盘是提升 iOPS 最经济的方式。</span></span></li><li id="https://www.notion.so/cb31975de943481aa4d6e349ddd25fb0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Scale up：比如把 MySQL 迁移到一个 CPU Core 更多的服务器以加强 CPU 计算能力，把 MySQL 从 SAS 磁盘迁移到 NVME-SSD 磁盘等。</span></span></li></ul></li></ul></article>
  <footer class="Footer">
</footer>
</body>

</html>